name: Run Text and Image Diff Checks
on:
  pull_request:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

concurrency:
  group: get-diff-${{ github.ref }}
  cancel-in-progress: true

jobs:
  get-dev-build:
    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v3
        with:
          ref: master

      - name: Get Workflow run ID
        id: workflow_run_id
        uses: actions/github-script@v6
        with:
          result-encoding: string
          script: |
            const workflowRuns = await github.paginate(github.rest.actions.listWorkflowRuns.endpoint.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-branch-dev.yml',
              branch: 'master',
              event: 'schedule',
              status: 'success'
            }));
            const workflowRunsSorted = workflowRuns.sort((a, b) => b.run_number - a.run_number);

            return workflowRunsSorted[0].id

    outputs:
      workflow_id: ${{ steps.workflow_run_id.outputs.result }}

  get-master-build:
    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v3
        with:
          ref: master

      - name: Get Workflow run ID
        id: workflow_run_id
        uses: actions/github-script@v6
        with:
          result-encoding: string
          script: |
            const workflowRuns = await github.paginate(github.rest.actions.listWorkflowRuns.endpoint.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-branch-master.yml',
              branch: 'master',
              event: 'schedule',
              status: 'success'
            }));
            const workflowRunsSorted = workflowRuns.sort((a, b) => b.run_number - a.run_number);

            return workflowRunsSorted[0].id

    outputs:
      workflow_id: ${{ steps.workflow_run_id.outputs.result }}

  check-diffs:
    runs-on: ubuntu-latest
    needs: [get-dev-build, get-master-build]

    steps:

      - uses: actions/checkout@v3
        with:
          ref: diff_action

      - name: Create Build Folders
        run: |
          mkdir dev-build
          mkdir master-build

      - name: Download Dev Artifact
        uses: XanaduAI/cloud-actions/download-github-workflow-artifact@main
        with:
          workflow_run_id: ${{ needs.get-dev-build.outputs.workflow_id }}
          artifact_name_regex: html.zip
          github_token: ${{ github.token }}
          artifact_download_dir: ${{ github.workspace }}/dev-build

      - name: Unpack Dev Artifact
        run: |
          cd dev-build
          FILE='html.zip.zip'
          if [ -f "$FILE" ]; then
            echo "$FILE exists."
            unzip html.zip
          fi

      - name: Download Master Artifact
        uses: XanaduAI/cloud-actions/download-github-workflow-artifact@main
        with:
          workflow_run_id: ${{ needs.get-master-build.outputs.workflow_id }}
          artifact_name_regex: html.zip
          github_token: ${{ github.token }}
          artifact_download_dir: ${{ github.workspace }}/master-build

      - name: Unpack Master Artifact
        run: |
          cd master-build
          FILE='html.zip.zip'
          if [ -f "$FILE" ]; then
            echo "$FILE exists."
            unzip html.zip
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Update Text Diff File
        run: |
          git config user.name "QML demo checker Bot"
          git config user.email "<>"

          pip install pytz
          python .github/workflows/generate_diffs.py
          mv demo_diffs.md demo_checker
          git add demo_checker/demo_diffs.md
          git commit -m "Update the demonstration text differences found"
          git push

      - name: Update Image Diff File
        run: |
          mkdir -p "$HOME/.local/bin"
          curl -O 'https://download.imagemagick.org/ImageMagick/download/binaries/magick'
          chmod u+x magick
          mv magick "$HOME/.local/bin"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

          git config user.name "QML demo checker Bot"
          git config user.email "<>"

          python .github/workflows/image_compare.py
          mv image_compare.md demo_checker
          git add demo_checker/image_compare.md
          git commit -m "Update the demonstration image differences found"
          git push

      - uses: actions/upload-artifact@v3
        with:
          name: demo_diffs
          path: |
            demo_checker/demo_diffs.md

      - uses: actions/upload-artifact@v3
        with:
          name: image_compare
          path: |
            demo_checker/image_compare.md